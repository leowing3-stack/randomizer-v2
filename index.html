<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>SocialBurst — 16-bit Game Boy Explorer</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!-- Brand fonts from your repo -->
<style>
  @font-face {
    font-family: "BrotherBold";
    src: url("./SocialBurstRandomizer/fonts/BROTHER-Bold.ttf") format("truetype");
    font-weight: 700; font-style: normal; font-display: swap;
  }
  @font-face {
    font-family: "Lexend";
    src: url("./SocialBurstRandomizer/fonts/Lexend-VariableFont_wght.ttf") format("truetype");
    font-weight: 100 900; font-style: normal; font-display: swap;
  }
  @font-face {
    font-family: "MadeTommyBold";
    src: url("./SocialBurstRandomizer/fonts/MADE TOMMY Bold_PERSONAL USE.otf") format("opentype");
    font-weight: 700; font-style: normal; font-display: swap;
  }

  :root{
    --purple:#8338EC;
    --yellow:#FFEC1F;
    --white:#ffffff;
    --black:#000000;

    --shell:#6a2ee0;
    --shell-dark:#4f22a8;
    --shell-light:#8d5bf0;

    --shadow:0 18px 40px rgba(0,0,0,.28);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 600px at 50% -20%, #eee, #d8d8ff 60%, #c7c7ff 100%);
    color:#0f0f12;
    font-family: Lexend, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    overflow:hidden;
  }

  header.topbar{
    position:fixed; top:8px; left:8px; right:8px; z-index:50;
    display:flex; align-items:center; gap:10px;
    background:rgba(255,255,255,0.7); backdrop-filter:blur(6px);
    border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:6px 10px;
  }
  .brand{display:flex; align-items:center; gap:8px}
  .brand img{width:32px; height:32px}
  .brand .name{font-family:BrotherBold, sans-serif; color:var(--purple); font-size:18px}
  .spacer{flex:1}
  .saved-btn{
    display:inline-flex; align-items:center; gap:8px; border:2px solid var(--purple);
    border-radius:999px; padding:6px 10px; background:transparent; color:var(--purple); font-weight:800; cursor:pointer;
  }
  .badge{
    min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:var(--yellow); color:#000;
    display:inline-flex; align-items:center; justify-content:center; font-size:12px; font-weight:800;
  }

  .wrap{
    height:100%; width:100%; display:grid; place-items:center; padding:60px 16px 24px;
  }
  .gb{
    position:relative;
    width:min(920px, 94vw);
    aspect-ratio: 3/5;
    background: linear-gradient(145deg, var(--shell-light), var(--shell) 40%, var(--shell-dark) 100%);
    border-radius:36px;
    box-shadow: var(--shadow);
    border:6px solid #2c0d76;
  }
  .gb::after{
    content:""; position:absolute; inset:0; border-radius:36px; pointer-events:none;
    box-shadow: inset 0 18px 32px rgba(255,255,255,0.18), inset 0 -18px 28px rgba(0,0,0,0.18);
  }

  .logo-badge{
    position:absolute; left:8%; top:4%;
    display:flex; align-items:center; gap:10px; color:#fff;
    font-family:BrotherBold, sans-serif; letter-spacing:.4px; text-shadow:0 1px 0 rgba(0,0,0,.35);
  }
  .logo-badge img{width:32px; height:32px; filter: drop-shadow(0 1px 0 rgba(0,0,0,.4));}

  .toggle{
    position:absolute; right:8%; top:4%;
    display:inline-flex; border:2px solid #fff; border-radius:999px; overflow:hidden; box-shadow:0 2px 0 rgba(0,0,0,.18);
  }
  .toggle button{
    padding:6px 12px; border:none; background:transparent; color:#fff; font-weight:900; cursor:pointer;
  }
  .toggle button[aria-pressed="true"]{ background:#fff; color:#301873; }

  .screen-bezel{
    position:absolute; left:6%; right:6%; top:7%;
    aspect-ratio: 5/3;
    background: linear-gradient(180deg, #222, #111 60%, #000);
    border-radius:22px; padding:14px; box-shadow: inset 0 0 0 2px #000;
  }
  .screen{
    position:relative; width:100%; height:100%; border-radius:12px; display:grid; place-items:center; padding:6px;
  }
  .screen-inner{
    width:100%; height:100%; background:#8CC7FF; border-radius:8px; image-rendering:pixelated; overflow:hidden; position:relative;
  }
  canvas#screen{width:100%; height:100%; display:block; image-rendering:pixelated}
  .screen-label{position:absolute; left:12px; bottom:10px; color:#0b2e0b; font-weight:900; font-size:12px; opacity:.6}
  .hint{position:absolute; top:6px; right:8px; z-index:5; background:#0b2e0b; color:#b6d64b; border:2px solid #215a21; border-radius:6px; padding:4px 6px; font-weight:900; font-size:12px; display:none}
  .hint.show{display:block}

  .dpad{
    position:absolute; left:11%; bottom:10%; width:160px; height:160px; display:grid; place-items:center;
  }
  .stem{position:absolute; background:#24104b; border:3px solid #0b0223; border-radius:12px; box-shadow: inset 0 0 0 2px rgba(255,255,255,0.06), 0 4px 0 rgba(0,0,0,0.25)}
  .stem.vert{width:56px; height:160px}
  .stem.horz{width:160px; height:56px}
  .d-btn{position:absolute; width:56px; height:56px; background: radial-gradient(circle at 35% 35%, #3a1b7a, #230c53); border:2px solid #0b0223; border-radius:10px; color:#fff; font-weight:900; cursor:pointer; display:grid; place-items:center; box-shadow:0 3px 0 rgba(0,0,0,.35)}
  .d-btn:active{transform:translateY(1px)}
  .d-up{top:0; left:52px}
  .d-left{left:0; top:52px}
  .d-right{right:0; top:52px}
  .d-btn span{transform:translateY(-1px)}

  .ab{position:absolute; right:11%; bottom:12%; display:flex; gap:16px; align-items:center}
  .round{width:64px; height:64px; border-radius:50%; background: radial-gradient(circle at 35% 35%, #ffd94d, #c0a300); border:3px solid #6a5c00; box-shadow:0 4px 0 rgba(0,0,0,.35); font-weight:900; color:#000; display:grid; place-items:center; cursor:pointer}
  .round:active{transform:translateY(1px)}

  #saved-panel{
    position:fixed; right:0; top:0; height:100%; width:min(92vw,420px); background:#fff; color:#0f0f12;
    border-left:1px solid rgba(0,0,0,.08); transform:translateX(100%); transition:transform .25s ease; z-index:120; display:grid; grid-template-rows:auto 1fr;
  }
  #saved-panel.open{transform:translateX(0)}
  #saved-panel header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(0,0,0,.08)}
  #saved-list{overflow:auto; padding:12px; display:grid; gap:10px}
  .saved-item{border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:12px; display:grid; gap:6px; background:#fff}
  .saved-item .title{font-weight:800; color:var(--purple)}
  .saved-item .meta{color:#3a3a44; font-weight:700}
  .saved-item .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .btn{padding:8px 12px; border-radius:999px; border:2px solid var(--purple); background:transparent; color:var(--purple); font-weight:800; cursor:pointer}
  .btn.primary{background:var(--purple); color:#fff}

  /* tiny badge for tweak mode */
  .tweak-badge{
    position:absolute; right:10px; top:10px; z-index:6;
    background:#000; color:#fff; font-weight:900; font-size:11px; padding:4px 6px; border-radius:6px; opacity:.75; display:none;
  }
  .tweak-on .tweak-badge{ display:block; }
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img src="./SocialBurstRandomizer/img/logo.png" alt="SocialBurst logo"/>
    <div class="name">SocialBurst</div>
  </div>
  <div class="spacer"></div>
  <button id="btn-saved" class="saved-btn">Saved <span id="saved-count" class="badge">0</span></button>
</header>

<div class="wrap">
  <div class="gb" role="application" aria-label="SocialBurst Game Boy Explorer">
    <div class="logo-badge">
      <img src="./SocialBurstRandomizer/img/logo.png" alt="">
      <div>GAME • BURST</div>
    </div>

    <div class="toggle" role="tablist" aria-label="Category">
      <button id="tab-events" role="tab" aria-pressed="true" aria-selected="true">Events</button>
      <button id="tab-deals" role="tab" aria-pressed="false" aria-selected="false">Deals</button>
    </div>

    <div class="screen-bezel">
      <div class="screen">
        <div class="screen-inner">
          <canvas id="screen" width="256" height="160" aria-label="Game screen"></canvas>
          <div id="hint" class="hint">↑ ENTER</div>
          <div id="tweakBadge" class="tweak-badge">TWEAK: 1=Grass 2=Dirt 3=Rock 4=Cloud 5=Fence 6=Tree 7=Cabin 8=Cottage 9=Windmill 0=Player • [ / ] cycle</div>
        </div>
        <div class="screen-label">SOCIALBURST DOT MATRIX</div>
      </div>
    </div>

    <div class="dpad" aria-label="D-pad">
      <div class="stem vert"></div>
      <div class="stem horz"></div>
      <button class="d-btn d-up" id="d-up" aria-label="Up"><span>↑</span></button>
      <button class="d-btn d-left" id="d-left" aria-label="Left"><span>←</span></button>
      <button class="d-btn d-right" id="d-right" aria-label="Right"><span>→</span></button>
    </div>

    <div class="ab">
      <button class="round" id="btn-details" title="Open details">A</button>
      <button class="round" id="btn-save" title="Save">B</button>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="display:none; align-items:center; justify-content:center; padding:16px; z-index:100; position:fixed; inset:0; background:rgba(0,0,0,.45);">
  <div class="modal">
    <header>
      <h2 id="modal-title">Title</h2>
      <button id="modal-close" class="close" aria-label="Close" style="border:none; background:transparent; font-size:24px; line-height:1; cursor:pointer; color:#444;">×</button>
    </header>
    <div class="meta">
      <div id="modal-when" class="btn" style="cursor:default"></div>
      <div id="modal-venue"></div>
      <div id="modal-address"></div>
      <div id="modal-phone"></div>
    </div>
    <div id="modal-desc"></div>
    <div id="modal-links" class="actions"></div>
    <div class="actions" style="margin-top:16px;">
      <button id="modal-save" class="btn primary">Save</button>
      <a id="modal-ics" class="btn" download="event.ics">Add to Calendar</a>
    </div>
  </div>
</div>

<!-- Saved Drawer -->
<aside id="saved-panel" aria-label="Saved items" aria-hidden="true">
  <header>
    <strong>Saved</strong>
    <button id="saved-close" class="btn" aria-label="Close">Close</button>
  </header>
  <div id="saved-list"></div>
</aside>

<script>
/* ================= BASIC CONFIG ================= */
var CSV_URL = "https://docs.google.com/spreadsheets/d/<SHEET_ID>/pub?gid=<GID_TODAY>&single=true&output=csv";
var TILE = 16, GROUND_Y = 120;
var PHYS = {
  walkSpeed: 60,
  deadzone: 36,
  gravity: 900,   // keep gravity feel
  jumpVel: 420,   // was 280; ~98px rise -> comfortably above tall platforms
  termVel: 800,   // keep fall slick at higher peaks
  coyoteTime: 0.08,
  jumpBuffer: 0.12
};
/* PATCH START: define keys state */
var keys = { left:false, right:false, up:false, jump:false };
/* PATCH END */
/* === PLAYER SPRITE CONFIG (folders + filenames) === */
var PLAYER_SPR = {
  scale: 1,   // bump to 2 if sprite is tiny

  idle: { dir: "south", frames: ["0.png","1.png","2.png","3.png"], fps: 6 },
  walk: { dir: "east",  frames: ["0.png","1.png","2.png","3.png","4.png","5.png"], fps: 10 },

  // NEW: 9-frame jump
  jump: { dir: "jump",  frames: ["0.png","1.png","2.png","3.png","4.png","5.png","6.png","7.png","8.png"], fps: 18 }
};

// runtime containers
var playerGfx = {
  idleFrames: [],
  walkFrames: [],
  jumpFrames: [],
  ready: false
};

// simple animation clock/state
var anim = { t: 0, state: "idle", playedJumpOnce: false };
function setAnim(state){
  if (anim.state !== state){
    anim.state = state;
    anim.t = 0; // reset the state clock on change
  }
}
/* ================= ELEMENTS ================= */
var canvas = document.getElementById('screen');
var ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;
var hintEl = document.getElementById('hint');
var tweakBadge = document.getElementById('tweakBadge');

var tabEvents = document.getElementById('tab-events');
var tabDeals  = document.getElementById('tab-deals');
var dUp   = document.getElementById('d-up');
var dLeft = document.getElementById('d-left');
var dRight= document.getElementById('d-right');
var btnA = document.getElementById('btn-details');
var btnB = document.getElementById('btn-save');

var btnSaved = document.getElementById('btn-saved');
var savedCountEl = document.getElementById('saved-count');
var savedPanel = document.getElementById('saved-panel');
var savedClose = document.getElementById('saved-close');
var savedList  = document.getElementById('saved-list');

var modalBackdrop = document.getElementById('modal-backdrop');
var modalTitle = document.getElementById('modal-title');
var modalWhen = document.getElementById('modal-when');
var modalVenue = document.getElementById('modal-venue');
var modalAddress = document.getElementById('modal-address');
var modalPhone = document.getElementById('modal-phone');
var modalDesc = document.getElementById('modal-desc');
var modalLinks = document.getElementById('modal-links');
var modalIcs = document.getElementById('modal-ics');
var modalClose = document.getElementById('modal-close');
var modalSave = document.getElementById('modal-save');

/* ================= STATE ================= */
var CATEGORY='events', EVENTS=[], DEALS=[], ITEMS=[];
var worldW=256*6, cameraX=0, cameraY=0, canEnterId=null, currentOpen=null;
var WORLD_H = 1200;   // rough world height; tweak later
var VDEADZONE = 40;   // vertical deadzone like horizontal
var WORLD_TOP = -800, WORLD_BOTTOM = 0; // vertical clamp; updated after building platforms


/* Player */
var player = {
  x: 16,
  y: GROUND_Y,
  vx: 0,
  vy: 0,
  step: 0,
  facing: 1,
  grounded: true,
  coyote: 0,          // timer
  jumpBuffer: 0       // timer
};
// --- Jump helpers (top-level, used by key handlers and physics) ---
function requestJump(){
  // buffer the intent; update() will consume it if possible
  player.jumpBuffer = PHYS.jumpBuffer;
}

function doJump(){
  player.vy = -PHYS.jumpVel;
  player.grounded = false;
  player.coyote = 0;
  setAnim("jump");                 // reset anim clock on takeoff
  anim.playedJumpOnce = false;

  // SMALL forward carry if moving
  if (player.vx !== 0) player.vx = player.facing * (PHYS.walkSpeed + 10);
}

function landOn(surfaceY){
  player.y = surfaceY;
  player.vy = 0;
  if (!player.grounded){
    player.grounded = true;
  }
  player.coyote = PHYS.coyoteTime;
  setAnim((player.vx !== 0) ? "walk" : "idle");
}
/* Parallax */
var parallax = { cloudsNearX:0, cloudsFarX:0, treeX:0 };

/* Scene */
/* Scene */
var houses=[], fences=[], pines=[];

/* One-way platform segments (world coordinates) */
var PLATFORMS = [];

/* Tileset Atlas + tweak */
var atlas=null;
var defaultMap = {
  grass:[0,1,2,3],      // 4 variants (indices on 16x16 grid)
  dirt:4,               // base dirt tile
  rock:5,               // dirt with rock
  cloud:6,              // cloud tile
  fence:7,              // fence tile (16x16; engine repeats)
  tree:8,               // big tree (drawn as a 3x4 tile block)
  cabin:9,              // cabin top-left (4x3 tiles area)
  cottage:21,           // cottage top-left (4x3)
  windmill:33,          // windmill body top-left (4x4)
  windmillBlades:[49,50,51,52], // 4 frames (each 4x4 or 4x4 area)
  player:65             // player 16x16 (single frame used as base; we offset for walk)
};
var map = loadTileMap() || defaultMap;
var tweak = { on:false, key:'grass', index:0 };
/* === LOAD PER-FRAME PNGs === */
function loadImage(url){
  return new Promise(function(resolve){
    var img = new Image();
    img.onload = function(){ resolve(img); };
    img.onerror = function(){
      console.warn("Missing sprite:", url);
      resolve(null); // don't reject; keep boot alive
    };
    img.src = url;
  });
}

function loadPlayerSprites(){
  var base = "./SocialBurstRandomizer/sprites/player/";

  function loadImage(url){
    return new Promise(function(resolve){
      var img = new Image();
      img.onload = function(){ resolve(img); };
      img.onerror = function(){ console.warn("Missing sprite:", url); resolve(null); };
      img.src = url;
    });
  }

  var idlePromises = PLAYER_SPR.idle.frames.map(function(f){
    return loadImage(base + PLAYER_SPR.idle.dir + "/" + f);
  });
  var walkPromises = PLAYER_SPR.walk.frames.map(function(f){
    return loadImage(base + PLAYER_SPR.walk.dir + "/" + f);
  });
  var jumpPromises = PLAYER_SPR.jump.frames.map(function(f){
    return loadImage(base + PLAYER_SPR.jump.dir + "/" + f);
  });

  return Promise.all([
    Promise.all(idlePromises),
    Promise.all(walkPromises),
    Promise.all(jumpPromises)
  ])
  .then(function(res){
    playerGfx.idleFrames = res[0].filter(Boolean);
    playerGfx.walkFrames = res[1].filter(Boolean);
    playerGfx.jumpFrames = res[2].filter(Boolean);
    playerGfx.ready = !!(playerGfx.idleFrames.length && playerGfx.walkFrames.length && playerGfx.jumpFrames.length);
  })
  .catch(function(err){
    console.warn("Player sprite load failed:", err);
    playerGfx.ready = false;
  });
}
/* ================= BOOT ================= */
window.addEventListener('DOMContentLoaded', function(){
  wireUI();
  Promise.all([
    loadAtlas("./SocialBurstRandomizer/sprites/socialburst_tileset.png"),
    loadPlayerSprites(),
    hydrate()
  ])
  .catch(function(err){
    console.warn("Boot continuing despite error:", err);
  })
  .then(function(){
    setCategory('events');
    updateSavedBadge();
    requestAnimationFrame(loop);
  });
});
function wireUI(){
  tabEvents.onclick=function(){ setCategory('events'); };
  tabDeals.onclick=function(){ setCategory('deals'); };

 /* PATCH START: dpad continuous press */
  function hold(el, on, off){
    var down=false, id=null;
    var start=function(e){ e.preventDefault(); down=true; on(); };
    var stop=function(e){ e && e.preventDefault(); if(down){ down=false; off(); } };
    el.addEventListener('mousedown', start);
    el.addEventListener('touchstart', start, {passive:false});
    window.addEventListener('mouseup', stop);
    window.addEventListener('touchend', stop);
    window.addEventListener('touchcancel', stop);
  }
  hold(dLeft,  function(){ keys.left=true; },  function(){ keys.left=false; });
  hold(dRight, function(){ keys.right=true; }, function(){ keys.right=false; });
  dUp.addEventListener('click', function(e){ e.preventDefault(); tryEnter(); });
/* PATCH END */

  btnA.onclick=function(e){
  e.preventDefault();
  requestJump();
};
  btnB.onclick=function(){ if (currentOpen) saveItem(currentOpen); };

  /* PATCH START: keyboard -> keys state */
  document.addEventListener('keydown', function(e){
    if (modalBackdrop.style.display==='flex'){
      if (e.key==='Escape') closeModal();
      if (e.key==='b'||e.key==='B'){ if(currentOpen) saveItem(currentOpen); }
      return;
    }
    if (e.key==='ArrowLeft' || e.key==='a' || e.key==='A') keys.left = true;
    if (e.key==='ArrowRight'|| e.key==='d' || e.key==='D') keys.right= true;
    if (e.key==='ArrowUp'   || e.key==='w' || e.key==='W' || e.key==='Enter') keys.up=true;

// === ADD: Jump controls ===
if (e.code === 'Space') {
  e.preventDefault();
  requestJump();
}
if (e.key === 'z' || e.key === 'Z') {
  requestJump();
}
// === END ADD ===


    // Tweak mode (unchanged)
    if (e.key==='t' || e.key==='T'){ tweak.on=!tweak.on; document.querySelector('.screen-inner').classList.toggle('tweak-on', tweak.on); }
    if (!tweak.on) return;
    if (e.key==='['){ cycleTile(-1); }
    if (e.key===']'){ cycleTile(1); }
    var num="1234567890".indexOf(e.key);
    if (num>=0) pickKey(num);
  });
  document.addEventListener('keyup', function(e){
    if (e.key==='ArrowLeft' || e.key==='a' || e.key==='A') keys.left = false;
    if (e.key==='ArrowRight'|| e.key==='d' || e.key==='D') keys.right= false;
    if (e.key==='ArrowUp'   || e.key==='w' || e.key==='W' || e.key==='Enter') keys.up=false;
  });
/* PATCH END */

  btnSaved.onclick=toggleSavedPanel;
  savedClose.onclick=function(){ setSavedPanel(false); };

  modalBackdrop.addEventListener('click', function(ev){ if (ev.target===modalBackdrop) closeModal(); });
  modalClose.onclick=closeModal;
  modalSave.onclick=function(){ if (currentOpen) saveItem(currentOpen); };
}

/* ================= ATLAS ================= */
function loadAtlas(src){
  return new Promise(function(resolve){
    var img=new Image(); img.onload=function(){ atlas={img:img, w:img.width, h:img.height, cols:(img.width/TILE)|0, rows:(img.height/TILE)|0}; resolve(); };
    img.src=src;
  });
}
function drawTileIndex(idx, dx,dy, dw,dh){
  var cols=atlas.cols;
  var sx=(idx%cols)*TILE, sy=((idx/cols)|0)*TILE;
  ctx.drawImage(atlas.img, sx,sy, TILE,TILE, dx,dy, dw||TILE, dh||TILE);
}

/* helper: draw multi-tile block starting at index (top-left) */
function drawBlock(topLeftIdx, wTiles, hTiles, dx, dy){
  var cols=atlas.cols;
  for (var ty=0; ty<hTiles; ty++){
    for (var tx=0; tx<wTiles; tx++){
      var idx = topLeftIdx + tx + cols*ty;
      drawTileIndex(idx, dx+tx*TILE, dy+ty*TILE);
    }
  }
}

/* ================= CSV & DATA ================= */
function hydrate(){
  return fetch(CSV_URL, {cache:'no-store'})
    .then(function(r){ if(!r.ok) throw new Error(r.status); return r.text(); })
    .then(function(text){
      var rows = csvToObjects(text);
      var p = partition(rows);
      EVENTS=p.events; DEALS=p.deals;
      if(!EVENTS.length && !DEALS.length){ var fb=fallback(); EVENTS=fb.events; DEALS=fb.deals; }
    })
    .catch(function(){
      var fb=fallback(); EVENTS=fb.events; DEALS=fb.deals;
    });
}
function csvToObjects(text){
  if(!text||!text.trim()) return [];
  var rows = csvRows(text);
  if(!rows.length) return [];
  var headers = rows[0].map(function(h){return String(h||'').trim().toLowerCase();});
  var out=[];
  for(var i=1;i<rows.length;i++){
    var r=rows[i]; if(r.every(function(c){return !String(c||'').trim();})) continue;
    var o={}; for(var j=0;j<headers.length;j++) o[headers[j]||('col_'+j)]=(r[j]==null?'':String(r[j])).trim();
    out.push(normalize(o,i));
  }
  return out;
}
function csvRows(text){
  var rows=[],cur='',row=[],q=false;
  for(var i=0;i<text.length;i++){
    var ch=text[i], nx=text[i+1];
    if(ch==='"'){ if(q && nx==='"'){cur+='"'; i++;} else q=!q; }
    else if(ch===',' && !q){ row.push(cur); cur=''; }
    else if((ch==='\n'||ch==='\r') && !q){ if(ch==='\r'&&nx==='\n') i++; row.push(cur); rows.push(row); row=[]; cur=''; }
    else cur+=ch;
  }
  row.push(cur); rows.push(row); return rows;
}
function normalize(obj, idx){
  function pick(keys,def){ for(var k=0;k<keys.length;k++){ var v=obj[keys[k]]; if(v!=null && String(v).trim()!=='') return String(v).trim(); } return def||''; }
  var type = pick(['type','category'],'').toLowerCase()==='deal' ? 'deal' : 'event';
  var title=pick(['title','name'])||'Untitled';
  var venue=pick(['venue','venue_name','business','place']);
  var when =pick(['when','time','window','start_datetime']);
  var desc =pick(['description','details','desc']);
  var link =pick(['link','url','website','source_url']);
  var addr =pick(['address','addr','location']);
  var phone=pick(['phone','tel','telephone']);
  var s=parseTime(pick(['start_datetime'],''));
  var e=parseTime(pick(['end_datetime'],''));
  if(s||e){
    var sTxt=s?s.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):'';
    var eTxt=e?e.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}):'';
    if(s&&e) when='Today '+sTxt+'–'+eTxt;
    else if(s) when='Today '+sTxt;
    else if(e) when='Until '+eTxt+' today';
  }
  return { id:hashId(title+'|'+venue+'|'+when+'|'+idx),
           type:type, title:title, venue:venue||'', when:when||'Today',
           description:desc||'', short:'', link:link||undefined, address:addr||undefined, phone:phone||undefined };
}
function parseTime(s){
  var t=String(s||'').toLowerCase().replace(/\u00a0|\u202f/g,' ').trim();
  var m=t.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm|a\.m\.|p\.m\.)?\s+(\d{1,2})\/(\d{1,2})$/i);
  if(!m) return null;
  var h=parseInt(m[1],10), mm=m[2]?parseInt(m[2],10):0, ap=(m[3]||'').replace(/\./g,'').toLowerCase();
  var d=parseInt(m[4],10), mo=parseInt(m[5],10), y=(new Date()).getFullYear();
  if(ap==='pm'&&h<12)h+=12; if(ap==='am'&&h===12)h=0;
  var dt=new Date(y,mo-1,d,h,mm,0,0); return isNaN(+dt)?null:dt;
}
function partition(items){
  var ev=[],de=[]; for(var i=0;i<items.length;i++) (items[i].type==='deal'?de:ev).push(items[i]);
  return {events:ev, deals:de};
}
function fallback(){
  return {
    events:[
      {id:'e1', type:'event', title:'Pub Quiz Night', when:'Today 19:30–21:30', venue:'The Jolly Sailor', description:'£50 bar tab • Teams up to 6', link:'#'},
      {id:'e2', type:'event', title:'Open Mic', when:'Today 20:00–22:30', venue:'The Horn', description:'Sign-ups from 19:00', link:'#'},
      {id:'e3', type:'event', title:'Board Game Social', when:'Today 18:00–22:00', venue:'White Lion', description:'Bring a game or join a table', link:'#'}
    ],
    deals:[
      {id:'d1', type:'deal', title:'2-for-1 Pizzas', when:'Valid until 17:00', venue:'Pinsa Lab', description:'Dine-in only', link:'#'},
      {id:'d2', type:'deal', title:'£5 Cocktails', when:'Today 17:00–19:00', venue:'Peahen', description:'House list only', link:'#'}
    ]
  };
}

/* ================= WORLD GEN ================= */
function setCategory(kind){
  CATEGORY=(kind==='deals')?'deals':'events';
  tabEvents.setAttribute('aria-pressed', String(CATEGORY==='events'));
  tabDeals.setAttribute('aria-pressed',  String(CATEGORY==='deals'));
  tabEvents.setAttribute('aria-selected', String(CATEGORY==='events'));
  tabDeals.setAttribute('aria-selected',  String(CATEGORY==='deals'));

  ITEMS=(CATEGORY==='events'?EVENTS:DEALS).slice();
  buildScene();
  player.x=16; cameraX=0; cameraY=0; canEnterId=null;
}

function buildScene(){
  buildHouses();
  buildFences();      // still draws ground fences between ground houses
  buildParallax();
  buildPlatforms();   // NEW
  placeHousesOnPlatforms(); // NEW
}
function buildHouses(){
  houses=[];
  var x=48, gap=128, list=(CATEGORY==='events'?EVENTS:DEALS);
  for (var i=0;i<list.length;i++){
    var it=list[i], seed=hashId(it.id).length + i*31;
    var kind=['cabin','cottage','windmill'][randInt(seed,0,2)];
    var wTiles= (kind==='windmill')?4:4;
    var hTiles= (kind==='windmill')?4:3;
    var w=wTiles*TILE, h=hTiles*TILE;
    houses.push({ id:it.id, title:it.title, when:it.when, x:x, w:w, h:h, kind:kind, seed:seed });
    x += gap + randInt(seed+3, -10, 24);
  }
  worldW=Math.max(256, (houses.length? houses[houses.length-1].x+160:256));
}
function buildFences(){
  fences=[];
  for (var i=0;i<houses.length-1;i++){
    var left=houses[i], right=houses[i+1];
    var start= left.x + Math.floor(left.w/2) + 12;
    var end  = right.x - Math.floor(right.w/2) - 12;
    for (var x=start; x<end; x+=TILE) fences.push({x:x});
  }
}
function buildParallax(){
  pines=[];
  for (var x=0; x<worldW; x+=28){
    var h=randInt(x+13, 3, 5); // rows of tiles tall
    pines.push({x:x+randInt(x+7,-4,6), rows:h});
  }
}
function buildPlatforms(){
  PLATFORMS = [];

  // How high can we jump comfortably?
  var maxRise = (PHYS.jumpVel * PHYS.jumpVel) / (2 * PHYS.gravity); // ≈ 98 with jumpVel 420
  var margin  = 10;                           // need to clear by a bit
  var safeRise = Math.floor(maxRise - margin); // ≈ 88

  // Make the first ledge sit ABOVE the tallest ground house (windmill is 4 tiles = 64px)
  var tallestHouse = 64;                       // 4 * TILE
  var firstY = GROUND_Y - (tallestHouse + 16); // ~80px above ground

  // Step height should be comfortably reachable:
  var stepY = Math.max(48, Math.min(safeRise, 96)); // clamp within a nice feel range

  // Horizontal spacing/width
  var gapMin = 140, gapMax = 180;
  var width  = 104;                             // a hair wider than before

  // Build a tall zig-zag up toward the top of the world
  var x = 48;
  var y = firstY;

  // Keep adding until we go well above the screen
  var i = 0;
  while (y > -600) { // climb ~600px above ground; tweak if you want even taller
    PLATFORMS.push({ x:x, y:y, w:width, h:6, row:i });

    // stagger horizontally: right then back-left
    var gapX = Math.floor(gapMin + Math.random() * (gapMax - gapMin));
    x += (i % 2 === 0) ? gapX : -Math.floor(gapX * 0.6);

    // go up
    y -= stepY;
    i++;
  }

  // OPTIONAL: sprinkle a few short "helper" ledges next to the main line
  for (var k = 0; k < PLATFORMS.length; k += 3) {
    var p = PLATFORMS[k];
    // small shelf to the side
    var sideW = 56;
    var sx = (k % 2 === 0) ? p.x + p.w + 40 : p.x - sideW - 40;
    PLATFORMS.push({ x: sx, y: p.y - Math.floor(stepY/2), w: sideW, h: 6, row: i + k });
  }

  // How high can we look? (remember: smaller y = higher in world)
  var minY = PLATFORMS.reduce(function(m, p){ return Math.min(m, p.y); }, GROUND_Y);
  // Allow camera to go a bit above the highest ledge
  WORLD_TOP = Math.min(-800, minY - 80);   // negative allowed so we can scroll up
  WORLD_BOTTOM = 0;                         // bottom of view near ground
}

function placeHousesOnPlatforms(){
  if (!PLATFORMS.length){ return; }

  // Sort platforms by height (low to high) so we fill from ground upward
  var plats = PLATFORMS.slice().sort(function(a,b){ return a.y - b.y; });

  // We’ll cycle houses across platforms, nudging house.x to sit on the deck
  for (var i = 0; i < houses.length; i++){
    var h = houses[i];

    // Every 3rd house stays on ground to keep the base alive
    if (i % 3 === 0) {
      h.baseY = GROUND_Y;
      continue;
    }

    // Pick a platform, rising as we advance through the list
    var p = plats[i % plats.length];

    // Snap the house horizontally so it actually sits on the segment
    var houseHalf = Math.floor(h.w / 2);
    var center    = Math.floor(p.x + p.w / 2);
    h.x = Math.max(p.x + houseHalf, Math.min(center, p.x + p.w - houseHalf));

    // Put the building on that platform surface
    h.baseY = p.y;
  }
}
function findPlatformUnderX(x, row){
  for (var i=0;i<PLATFORMS.length;i++){
    var p = PLATFORMS[i];
    if (p.row===row && x >= p.x && x <= p.x + p.w) return p;
  }
  return null;
}


/* ================= GAME LOOP ================= */
/* PATCH START: dt loop + acceleration physics */
var _lastT = performance.now();
function loop(){
  var now = performance.now();
  var dt  = Math.min(0.05, (now - _lastT) / 1000); // clamp 50ms
  _lastT = now;

  update(dt);
  render();
  requestAnimationFrame(loop);
}

function update(dt){
  // --- HORIZONTAL (unchanged feel) ---
  var want = 0;
  if (keys.left && !keys.right)  want = -PHYS.walkSpeed;
  else if (keys.right && !keys.left) want =  PHYS.walkSpeed;

  player.vx = want;
  if (player.vx !== 0) player.facing = (player.vx > 0 ? 1 : -1);
  player.x += player.vx * dt;

  if (player.x < 0) player.x = 0;
  if (player.x > worldW - 8) player.x = worldW - 8;

  // --- COYOTE & BUFFER TIMERS ---
  if (!player.grounded){
    player.coyote = Math.max(0, player.coyote - dt);
  } else {
    player.coyote = PHYS.coyoteTime;
  }
  if (player.jumpBuffer > 0) {
    player.jumpBuffer = Math.max(0, player.jumpBuffer - dt);
  }

  // --- VERTICAL PHYSICS ---
   // --- VERTICAL PHYSICS ---
  if (!player.grounded){
    player.vy += PHYS.gravity * dt;
    if (player.vy > PHYS.termVel) player.vy = PHYS.termVel;
  }

  var prevY = player.y;   // <— add this
  player.y += player.vy * dt;

  // --- One-way platform collisions: land only when falling and crossing top surface ---
  var landedOnPlatform = false;
  if (player.vy >= 0){ // falling or resting
    for (var i=0;i<PLATFORMS.length;i++){
      var p = PLATFORMS[i];
      var withinX = (player.x >= p.x) && (player.x <= p.x + p.w);
      var crossedTop = (prevY <= p.y) && (player.y >= p.y);
      if (withinX && crossedTop){
            landOn(p.y);
      landedOnPlatform = true;
      break;
      }
    }
  }
  
  // ground collision at GROUND_Y
  if (!landedOnPlatform){
    if (player.y >= GROUND_Y){
      player.y = GROUND_Y;
      player.vy = 0;
      if (!player.grounded){
        player.grounded = true;
        // if a jump was buffered just before landing, consume it now
        if (player.jumpBuffer > 0){
          player.jumpBuffer = 0;
          doJump();
          player.grounded = false;
        }
      }
    } else {
      player.grounded = false;
    }
  }


  // --- CONSUME JUMP BUFFER while airborne but within coyote time (leaving edges)
  if (player.jumpBuffer > 0 && (player.grounded || player.coyote > 0)){
    player.jumpBuffer = 0;
    doJump();
  }

  // --- ANIMATION STATE ---
if (!player.grounded){
  setAnim((player.vy < 0) ? "jump" : "fall");
} else {
  setAnim((player.vx !== 0) ? "walk" : "idle");
}
anim.t += dt;

  // simple legacy step (used by pixel fallback)
  if (player.vx !== 0) { player.step = (player.step + 10*dt) % 2; } else { player.step = 0; }

  // --- CAMERA ---
  var leftDZ  = (player.x - PHYS.deadzone) - canvas.width/2;
  var rightDZ = (player.x + PHYS.deadzone) - canvas.width/2;
  if (cameraX > leftDZ)  cameraX = Math.max(leftDZ, cameraX - 120*dt);
  if (cameraX < rightDZ) cameraX = Math.min(rightDZ, cameraX + 120*dt);
  if (cameraX < 0) cameraX = 0;
  if (cameraX > worldW - canvas.width) cameraX = worldW - canvas.width;
// --- VERTICAL CAMERA FOLLOW ---
var targetY = player.y - canvas.height * 0.45;  // slight bias above center
var smooth  = 8 * dt;                            // follow speed; 6–10 feels good
if (smooth > 1) smooth = 1;
cameraY += (targetY - cameraY) * smooth;

// clamp camera to world vertical bounds (WORLD_TOP is negative, WORLD_BOTTOM near 0)
if (cameraY < WORLD_TOP)    cameraY = WORLD_TOP;
if (cameraY > WORLD_BOTTOM) cameraY = WORLD_BOTTOM;


  // --- PARALLAX ---
  parallax.cloudsNearX += 20*dt;
  parallax.cloudsFarX  -= 10*dt;
  parallax.treeX = cameraX * 0.5;

  // --- ENTER detection unchanged ---
  var aligned = null;
  for (var i=0;i<houses.length;i++){
    var door = doorXFor(houses[i]);
    if (Math.abs(door - player.x) < 8){ aligned = houses[i]; break; }
  }
  if (aligned && player.grounded){ // only show hint when on ground
    canEnterId = aligned.id; hintEl.classList.add('show');
  } else {
    canEnterId = null; hintEl.classList.remove('show');
  }

  if (keys.up && canEnterId){ tryEnter(); keys.up = false; }
}

/* ================= RENDER ================= */
function render(){
  // SKY gradient (underlay)
  var top=0xBDE4FF, mid=0x8CC9FF, bot=0x6BB1F4;
  for (var y=0;y<GROUND_Y;y++){
    var t=y/GROUND_Y, hex=(t<0.5)?lerpRGB(top,mid,t/0.5):lerpRGB(mid,bot,(t-0.5)/0.5);
    horizLine(0,y,canvas.width,hex);
  }

  // Clouds layer (tile the cloud index)
  drawCloudLayer(map.cloud, parallax.cloudsFarX, 12 - cameraY, 0.15);
  drawCloudLayer(map.cloud, parallax.cloudsNearX, 28 - cameraY, 0.30);

  // Tree silhouettes (parallax)
  drawTreeline();

  // Ground
  drawGround();

  // Fences
  for (var i=0;i<fences.length;i++){
    var fx = fences[i].x - cameraX;
    drawTileIndex(map.fence, fx, (GROUND_Y-10) - cameraY);
  }

  // Buildings
  for (var h=0; h<houses.length; h++){
    drawBuilding(houses[h]);
  }

  // Player
 drawPlayer(Math.round(player.x - cameraX), Math.round(player.y - cameraY));
}

/* ---------- DRAW HELPERS ---------- */
function drawCloudLayer(tileIdx, scroll, y, speed){
  var start = (-((scroll*speed)|0)) % TILE; if (start>0) start -= TILE;
  for (var x=start; x<canvas.width; x+=TILE){
    drawTileIndex(tileIdx, x, y);
  }
}
/* PATCH START: doorX helper */
function doorXFor(h){
  // crude door placement per kind; tweak if art changes
  var half = h.w/2;
  if (h.kind==='cabin')   return h.x - half + TILE*1.5;
  if (h.kind==='cottage') return h.x + half - TILE*1.5;
  // windmill center-ish
  return h.x;
}
/* PATCH END */
function drawTreeline(){
  // use the tree tile as repeated silhouettes (darken via globalAlpha)
  ctx.save();
  ctx.globalAlpha = 0.65;
  var offset = - (parallax.treeX|0) % (TILE*3);
  for (var x=offset - TILE*3; x<canvas.width; x+=TILE*3){
    // draw tree as a 3x4 block (assuming big tree at map.tree)
    drawBlock(map.tree, 3, 4, x, (GROUND_Y - 32) - cameraY);
  }
  ctx.restore();
}
function drawPlatforms(){
  // Simple beams with a little drop shadow
  for (var i=0;i<PLATFORMS.length;i++){
    var p = PLATFORMS[i];
    var sx = p.x - cameraX;
    var sy = p.y - cameraY;

    // shadow
   fillRect(sx, sy+1, p.w, p.h, 0x2b1b30);
    // deck
    fillRect(sx, sy,   p.w, p.h, 0x5f4db0); // placeholder color; swap to tiles later
    // top highlight
    fillRect(sx, sy-1, p.w, 1,   0xbcaeff);
  }
}

function drawGround(){
  // grass lip — use up to 4 variant tiles
  var variants = Array.isArray(map.grass) ? map.grass : [map.grass];
  for (var x = 0; x < canvas.width; x += TILE){
    var idx = variants[(((x + cameraX) / TILE) % variants.length) | 0];
    drawTileIndex(idx, x, (GROUND_Y - 8) - cameraY);
  }

  // Platforms (drawn above the ground)
  drawPlatforms();

  // purple soil body
  for (var y = GROUND_Y - cameraY; y < canvas.height; y += TILE){
    for (var x = 0; x < canvas.width; x += TILE){
      drawTileIndex(map.dirt, x, y);
      if (((y + cameraY) % 32 === 0) && (((x + cameraX) % 48) === 0)) {
        drawTileIndex(map.rock, x, y); // sprinkle rocks
      }
    }
  }
}

function drawBuilding(h){
  var screenX = h.x - cameraX;
  var baseY = (typeof h.baseY === "number") ? h.baseY : GROUND_Y;
  var x = screenX - Math.floor(h.w/2);
  var y = (baseY - h.h) - cameraY;
 

  if (h.kind==='cabin'){
    drawBlock(map.cabin, 4,3, x,y);
  } else if (h.kind==='cottage'){
    drawBlock(map.cottage, 4,3, x,y);
  } else { // windmill
    // body
    drawBlock(map.windmill, 4,4, x,y);
    // blades (centered)
    var frame = Math.floor((Date.now()/160)% (Array.isArray(map.windmillBlades)?map.windmillBlades.length:1));
    var bladeTopLeft = Array.isArray(map.windmillBlades)?map.windmillBlades[frame]:map.windmillBlades;
    drawBlock(bladeTopLeft, 4,4, x, y - 4); // slight offset so it overlaps top
  }

  // Title label above roof using tiny pixel text
  pixelText(h.title.toUpperCase(), x, y-10, 0x143C0D, h.w);
}

function drawPlayer(x, y){
  // shadow
  fillRect(x-3, y, 8, 1, 0x2b1b30);

  // tilesheet fallback if PNGs not ready
  if (typeof map.player === 'number' && !playerGfx.ready){
    drawTileIndex(map.player, x-4, y-16);
    return;
  }

  if (playerGfx.ready){
    var frames, fps, idx;

    if (anim.state === "walk"){
      frames = playerGfx.walkFrames; fps = PLAYER_SPR.walk.fps;
      idx = Math.floor(anim.t * fps) % frames.length;
    } else if (anim.state === "idle"){
      frames = playerGfx.idleFrames; fps = PLAYER_SPR.idle.fps;
      idx = Math.floor(anim.t * fps) % frames.length;
    } else {
      // jump/fall: play jump strip once on takeoff, then hold last frame while airborne
      frames = playerGfx.jumpFrames; fps = PLAYER_SPR.jump.fps;
      var jumpProgress = Math.min(frames.length - 1, Math.floor(anim.t * fps));
      idx = (player.vy < 0) ? jumpProgress : (frames.length - 1); // rising anim, falling hold last
    }

    if (frames && frames.length){
      var img = frames[idx] || frames[frames.length - 1];
      var scale = PLAYER_SPR.scale || 1;
      var w = Math.round(img.width  * scale);
      var h = Math.round(img.height * scale);

      if (player.facing < 0){
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(-1, 1);
        ctx.drawImage(img, -Math.floor(w/2), -h, w, h);
        ctx.restore();
      } else {
        ctx.drawImage(img, Math.floor(x - w/2), y - h, w, h);
      }
      return;
    }
  }

  // FINAL FALLBACK: tiny pixel dude
  var wob = (player.vx!==0 ? (((anim.t*10)|0) % 2) : 0) * (player.facing>0?1:-1);
  fillRect(x-2, y-14, 6, 5, 0xf2c199); // head
  fillRect(x-3, y-9,  8, 6, 0x6332c8); // body
  fillRect(x-3+wob, y-3, 3, 3, 0x222222);
  fillRect(x+2-wob, y-3, 3, 3, 0x222222);
}

/* ---------- UI: ENTER / MODAL ---------- */
function tryEnter(){
  if(!canEnterId) return;
  var it=getById(canEnterId); if(!it) return;
  openDetails(it);
}
function getById(id){ for(var i=0;i<ITEMS.length;i++) if(ITEMS[i].id===id) return ITEMS[i]; return null; }
function openDetails(item){
  currentOpen=item;
  modalTitle.textContent=item.title||'(Untitled)';
  modalWhen.textContent=item.when||'Today';
  modalVenue.textContent=item.venue||'';
  modalAddress.textContent=item.address||'';
  modalPhone.textContent=item.phone||'';
  modalDesc.textContent=item.description||'';

  while (modalLinks.firstChild) modalLinks.removeChild(modalLinks.firstChild);
  if(item.link){ var a=document.createElement('a'); a.className='btn'; a.href=item.link; a.target='_blank'; a.rel='noopener'; a.textContent='Open link'; modalLinks.appendChild(a); }
  if(item.address){ var g=document.createElement('a'); g.className='btn'; g.href='https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(item.address); g.target='_blank'; g.rel='noopener'; g.textContent='Get directions'; modalLinks.appendChild(g); }
  if(item.phone){ var p=document.createElement('a'); p.className='btn'; p.href='tel:'+item.phone.replace(/\s+/g,''); p.textContent='Call'; modalLinks.appendChild(p); }

  modalIcs.href = makeIcs(item);
  modalBackdrop.style.display='flex';
}
function closeModal(){ modalBackdrop.style.display='none'; }

/* ---------- SAVED PANEL ---------- */
function getSaved(){ try{ return JSON.parse(localStorage.getItem('sb_saved')||'[]'); }catch(e){ return []; } }
function setSaved(arr){ localStorage.setItem('sb_saved', JSON.stringify(arr)); }
function updateSavedBadge(){ savedCountEl.textContent=String(getSaved().length); }
function saveItem(item){
  var arr=getSaved(); for(var i=0;i<arr.length;i++) if(arr[i].id===item.id){ closeModal(); return; }
  arr.push(item); setSaved(arr); updateSavedBadge(); renderSavedList(); closeModal();
}
function removeSaved(id){ var arr=getSaved().filter(function(x){return x.id!==id;}); setSaved(arr); updateSavedBadge(); renderSavedList(); }
function renderSavedList(){
  savedList.innerHTML='';
  var arr=getSaved();
  if(!arr.length){ savedList.textContent='No saved items yet.'; return; }
  for (var i=0;i<arr.length;i++){
    (function(it){
      var card=document.createElement('div'); card.className='saved-item';
      var title=document.createElement('div'); title.className='title'; title.textContent=it.title;
      var meta=document.createElement('div'); meta.className='meta'; meta.textContent=(it.when||'Today')+(it.venue?(' • '+it.venue):'');
      var row=document.createElement('div'); row.className='row';
      var det=document.createElement('button'); det.className='btn'; det.textContent='Details'; det.onclick=function(){ openDetails(it); };
      var rem=document.createElement('button'); rem.className='btn primary'; rem.textContent='Remove'; rem.onclick=function(){ removeSaved(it.id); };
      row.appendChild(det); row.appendChild(rem);
      card.appendChild(title); card.appendChild(meta); card.appendChild(row);
      savedList.appendChild(card);
    })(arr[i]);
  }
}
function toggleSavedPanel(){ setSavedPanel(!savedPanel.classList.contains('open')); }
function setSavedPanel(open){
  if(open){ renderSavedList(); savedPanel.classList.add('open'); btnSaved.setAttribute('aria-expanded','true'); savedPanel.setAttribute('aria-hidden','false'); }
  else    { savedPanel.classList.remove('open'); btnSaved.setAttribute('aria-expanded','false'); savedPanel.setAttribute('aria-hidden','true'); }
}

/* ---------- ICS ---------- */
function makeIcs(item){
  var now=new Date();
  var start=parseWhen(item.when)||new Date(now.getFullYear(),now.getMonth(),now.getDate(),19,0,0);
  var end=new Date(start.getTime()+60*60*1000);
  function p(n){return (n<10?'0':'')+n;}
  function fmt(dt){return dt.getUTCFullYear()+p(dt.getUTCMonth()+1)+p(dt.getUTCDate())+'T'+p(dt.getUTCHours())+p(dt.getUTCMinutes())+p(dt.getUTCSeconds())+'Z';}
  var lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//SocialBurst//GameBoy//EN','BEGIN:VEVENT',
    'UID:'+item.id+'@socialburst','DTSTAMP:'+fmt(new Date()),'DTSTART:'+fmt(start),'DTEND:'+fmt(end),
    'SUMMARY:'+esc(item.title||''),'LOCATION:'+esc(item.venue||''),'DESCRIPTION:'+esc((item.description||'')+(item.link?(' '+item.link):'')),
    'END:VEVENT','END:VCALENDAR'];
  return URL.createObjectURL(new Blob([lines.join('\r\n')],{type:'text/calendar'}));
}
function parseWhen(str){ var m=String(str||'').toLowerCase().match(/today\s+(\d{1,2}):(\d{2})/); if(!m) return null; var h=+m[1],mi=+m[2]; var n=new Date(); return new Date(n.getFullYear(),n.getMonth(),n.getDate(),h,mi,0,0); }
function esc(s){ return String(s).replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n'); }

/* ---------- LOW LEVEL DRAW ---------- */
function putPixel(x,y,hex){ ctx.fillStyle='#'+hex.toString(16).padStart(6,'0'); ctx.fillRect(x|0,y|0,1,1); }
function fillRect(x,y,w,h,hex){ ctx.fillStyle='#'+hex.toString(16).padStart(6,'0'); ctx.fillRect(x|0,y|0,w|0,h|0); }
function horizLine(x,y,len,hex){ fillRect(x,y,len,1,hex); }
function tri(x1,y1,x2,y2,x3,y3,hex){ ctx.fillStyle='#'+hex.toString(16).padStart(6,'0'); ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.lineTo(x3,y3); ctx.closePath(); ctx.fill(); }
function lerpRGB(a,b,t){
  var ar=(a>>16)&255, ag=(a>>8)&255, ab=a&255;
  var br=(b>>16)&255, bg=(b>>8)&255, bb=b&255;
  var rr=(ar+(br-ar)*t)|0, gg=(ag+(bg-ag)*t)|0, bb2=(ab+(bb-ab)*t)|0;
  return (rr<<16)|(gg<<8)|bb2;
}

/* ---------- Pixel text 3x5 ---------- */
var FONT={A:["010","101","111","101","101"],B:["110","101","110","101","110"],C:["011","100","100","100","011"],D:["110","101","101","101","110"],E:["111","100","110","100","111"],F:["111","100","110","100","100"],G:["011","100","101","101","011"],H:["101","101","111","101","101"],I:["111","010","010","010","111"],J:["001","001","001","101","010"],K:["101","101","110","101","101"],L:["100","100","100","100","111"],M:["101","111","111","101","101"],N:["101","111","111","111","101"],O:["010","101","101","101","010"],P:["110","101","110","100","100"],Q:["010","101","101","111","011"],R:["110","101","110","101","101"],S:["011","100","010","001","110"],T:["111","010","010","010","010"],U:["101","101","101","101","111"],V:["101","101","101","101","010"],W:["101","101","111","111","101"],X:["101","101","010","101","101"],Y:["101","101","010","010","010"],Z:["111","001","010","100","111"]," ":[ "000","000","000","000","000" ]};
function pixelText(s,x,y,color,maxWidth){
  var px=x, w=4, chars=Math.min(Math.floor((maxWidth||1000)/w), s.length);
  s=s.toUpperCase();
  for(var i=0;i<chars;i++){
    var g=FONT[s[i]]||FONT[" "]; for(var r=0;r<5;r++){ var row=g[r]; for(var c=0;c<3;c++) if(row[c]==='1') putPixel(px+c, y+r, color); }
    px+=w;
  }
}

/* ---------- UTILS ---------- */
function hashId(s){ var h=0; for(var i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return 'sb_'+Math.abs(h); }
function rand01(seed){ var x=Math.sin(seed)*10000; return x - Math.floor(x); }
function randInt(seed,min,max){ return Math.floor(rand01(seed)*(max-min+1))+min; }
function nudge(dir){ player.vx=dir*1.8; player.facing=(dir<0?-1:1); setTimeout(function(){ if((dir<0 && player.vx<0)||(dir>0 && player.vx>0)) player.vx=0; },120); }

/* ---------- TWEAK MODE ---------- */
function loadTileMap(){ try{ return JSON.parse(localStorage.getItem('sb_tilemap')||''); }catch(e){ return null; } }
function saveTileMap(){ localStorage.setItem('sb_tilemap', JSON.stringify(map)); }
function pickKey(num){
  var keys=['grass','dirt','rock','cloud','fence','tree','cabin','cottage','windmill','player'];
  var k = (num===0)?'player':keys[num-1];
  tweak.key=k; tweak.index=0;
}
function cycleTile(delta){
  var k=tweak.key;
  if (Array.isArray(map[k])){
    // edit the first element by cycling, or push a new one
    var arr=map[k]; var v=(arr[tweak.index]||arr[0]||0) + delta; if (v<0) v=0;
    arr[tweak.index]=v;
  } else {
    var v=(map[k]||0)+delta; if (v<0) v=0; map[k]=v;
  }
  saveTileMap();
}
</script>
</body>
</html>
